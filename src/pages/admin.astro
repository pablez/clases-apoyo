---
import Layout from '../layouts/Layout.astro';
import AttendanceManager from '../components/AttendanceManager.jsx';
import AlumnosManager from '../components/AlumnosManager.jsx';
import MaterialesManager from '../components/MaterialesManager.jsx';
import CalendarManager from '../components/CalendarManager.jsx';

const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD || 'admin123';
---

<Layout title="Panel de Administraci칩n">
  <div id="auth-container" class="max-w-md mx-auto px-4 py-8 sm:py-12">
    <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-blue-100 rounded-full mb-4">
          <svg class="w-8 h-8 sm:w-10 sm:h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold mb-2">Panel de Administraci칩n</h1>
        <p class="text-gray-600 text-sm sm:text-base">Accediendo... si no est치s autenticado ser치s redirigido al formulario de acceso</p>
      </div>
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-gray-100 rounded">Comprobando credenciales...</div>
      </div>
    </div>
  </div>

  <div id="admin-panel" class="hidden">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6 gap-3">
      <h1 class="text-2xl sm:text-3xl font-bold">Panel de Gesti칩n</h1>
    </div>
    
    <!-- Pesta침as - Responsive -->
    <div class="mb-4 sm:mb-6 border-b overflow-x-auto">
      <nav class="flex gap-2 sm:gap-4 min-w-max sm:min-w-0">
        <button 
          class="tab-button px-3 sm:px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600 text-sm sm:text-base whitespace-nowrap"
          data-tab="asistencia"
        >
          <span class="hidden sm:inline">游늵 Asistencia</span>
          <span class="sm:hidden">游늵</span>
        </button>
        <button 
          class="tab-button px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-sm sm:text-base whitespace-nowrap"
          data-tab="alumnos"
        >
          <span class="hidden sm:inline">游논 Alumnos</span>
          <span class="sm:hidden">游논</span>
        </button>
        <button 
          class="tab-button px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-sm sm:text-base whitespace-nowrap"
          data-tab="materiales"
        >
          <span class="hidden sm:inline">游닄 Materiales</span>
          <span class="sm:hidden">游닄</span>
        </button>
        <button 
          class="tab-button px-3 sm:px-4 py-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 text-sm sm:text-base whitespace-nowrap"
          data-tab="calendario"
        >
          <span class="hidden sm:inline">游늰 Calendario</span>
          <span class="sm:hidden">游늰</span>
        </button>
      </nav>
    </div>

    <!-- Contenido de pesta침as -->
    <div id="tab-asistencia" class="tab-content">
      <AttendanceManager client:load apiBaseUrl="/api" />
    </div>

    <div id="tab-alumnos" class="tab-content hidden">
      <AlumnosManager client:load apiBaseUrl="/api" />
    </div>

    <div id="tab-materiales" class="tab-content hidden">
      <MaterialesManager client:load apiBaseUrl="/api" />
    </div>

    <div id="tab-calendario" class="tab-content hidden">
      <CalendarManager client:load apiBaseUrl="/api" />
    </div>
  </div>

  <script define:vars={{ ADMIN_PASSWORD }}>
    const authContainer = document.getElementById('auth-container');
    const adminPanel = document.getElementById('admin-panel');
    const passwordInput = document.getElementById('password-input');
    const loginBtn = document.getElementById('login-btn');
    const errorMsg = document.getElementById('error-msg');

    // Immediately verify server-side auth (token or cookie). If not admin, redirect to /login
    (async function(){
      try {
        let token = null;
        try { token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token'); } catch(e) { token = null; }

        // Try 1: prefer cookie-based auth (credentials only) to avoid stale tokens in storage
        let resp = await fetch('/api/alumno/asistencias', { credentials: 'include' });

        // If cookie auth failed and we have a stored token, try again with Authorization header
        if ((!resp || !resp.ok) && token) {
          resp = await fetch('/api/alumno/asistencias', { credentials: 'include', headers: { Authorization: `Bearer ${token}` } });
        }

        if (!resp || !resp.ok) {
          // not authenticated
          window.location.href = '/login';
          return;
        }

        const body = await resp.json();
        const isAdmin = body && body.alumno && body.alumno._usuario && String(body.alumno._usuario.rol || '').toLowerCase() === 'admin';
        if (!isAdmin) {
          window.location.href = '/login';
          return;
        }

        // mark admin flag for Navbar and show panel
        try { sessionStorage.setItem('admin_auth', 'true'); } catch(e){}
        authContainer.classList.add('hidden');
        adminPanel.classList.remove('hidden');
      } catch (e) {
        console.warn('Auth check failed:', e && e.message);
        window.location.href = '/login';
      }
    })();

    if (passwordInput) {
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          try { loginBtn && loginBtn.click(); } catch (err) {}
        }
      });
    }

    // Logout removed: authentication is handled via LoginForm and global navbar

    // Tabs functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.dataset.tab;
        
        // Update button styles
        tabButtons.forEach(btn => {
          if (btn === button) {
            btn.classList.add('border-blue-600', 'text-blue-600');
            btn.classList.remove('border-transparent', 'text-gray-600');
          } else {
            btn.classList.remove('border-blue-600', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-600');
          }
        });

        // Show/hide content
        tabContents.forEach(content => {
          if (content.id === `tab-${tabName}`) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
        });
      });
    });
  </script>
</Layout>
